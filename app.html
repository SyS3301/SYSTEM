<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>App Multilang</title>
  <style>
    body { font-family: sans-serif; background: #0f0f12; color: white; padding: 20px; }
    
    <!-- /* Основной контейнер для промо-поста */ -->
    <!-- #promo-container { -->
      <!-- display: none; -->
      <!-- background: linear-gradient(45deg, #1e1b4b, #312e81); -->
      <!-- padding: 30px; -->
      <!-- border-radius: 16px; -->
      <!-- text-align: center; -->
      <!-- box-shadow: 0 15px 35px rgba(0,0,0,0.4); -->
      <!-- border: 1px solid rgba(255,255,255,0.1); -->
      <!-- max-width: 600px; -->
      <!-- margin: 20px auto; -->
    <!-- } -->

    /* Переключатель языков */
    .lang-switcher {
      margin-bottom: 25px;
      display: flex;
      justify-content: center;
      gap: 12px;
    }

    .lang-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.3);
      color: rgba(255,255,255,0.7);
      padding: 8px 16px;
      cursor: pointer;
      border-radius: 8px;
      text-transform: uppercase;
      font-weight: bold;
      transition: all 0.3s ease;
    }

    /* Стиль активной кнопки */
    .lang-btn.active {
      background: white;
      color: #4f46e5;
      border-color: white;
      box-shadow: 0 0 15px rgba(255,255,255,0.2);
    }

    #promo-content {
      line-height: 1.6;
      font-size: 1.1rem;
    }

    #default-content { display: none; text-align: center; margin-top: 50px; }
    .debug-info { color: #555; font-size: 10px; margin-top: 50px; text-align: center; }
	
	/* Скрываем всё до проверки прав */
	#promo-container, #default-content {
	  display: none;
	}
  </style>
</head>
<body>

  <div id="promo-container">
    <div class="lang-switcher" id="lang-btns"></div>
    <div id="promo-content"></div>
  </div>

  <div id="default-content">
    <h1>Обычный контент</h1>
    <p>Добро пожаловать в основное приложение.</p>
  </div>

  <div class="debug-info" id="debug">Status: Инициализация...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6GybNkPBa28UWm9rpPhkUe8Q4JYtqQm4",
  authDomain: "system-85dfe.firebaseapp.com",
  projectId: "system-85dfe",
  storageBucket: "system-85dfe.firebasestorage.app",
  messagingSenderId: "76734526218",
  appId: "1:76734526218:web:8a9eb4e0df4a58741980f3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const debugDiv = document.getElementById("debug");

let translations = {};

onAuthStateChanged(auth, async (user) => {
  // 1. Если пользователя нет — немедленный вылет на логин
  if (!user) { 
    console.log("Доступ запрещен: Пользователь не авторизован");
    window.location.replace("index.html"); // replace лучше, чтобы нельзя было нажать "Назад"
    return; 
  }
  
  // Если мы здесь — пользователь вошел.
  debugDiv.innerText = "Авторизация успешна. Загрузка данных...";

  try {
    const snap = await getDoc(doc(db, "promo", "NuetuWkhDrGfCX8a1UxL"));
    
    if (snap.exists()) {
      const data = snap.data();
      const now = Date.now();
      const expiresAt = data.expiresAt?.toMillis() || 0;

      if (data.active && now < expiresAt) {
        translations = data.html || {}; 
        const langKeys = Object.keys(translations);
        
        if (langKeys.length > 0) {
          renderLangButtons(langKeys);
          const randomLang = langKeys[Math.floor(Math.random() * langKeys.length)];
          switchLang(randomLang);
          
          // Показываем контент ТОЛЬКО ТУТ
          document.getElementById("promo-container").style.display = "block";
        } else {
          showDefault();
        }
      } else {
        showDefault();
      }
    } else {
      showDefault();
    }
  } catch (e) {
    console.error(e);
    showDefault();
  }
});

// Обновите функцию showDefault, чтобы она явно включала видимость
function showDefault() {
  document.getElementById("promo-container").style.display = "none";
  document.getElementById("default-content").style.display = "block";
}

function renderLangButtons(langKeys) {
  const container = document.getElementById("lang-btns");
  container.innerHTML = "";
  
  langKeys.forEach(lang => {
    const btn = document.createElement("button");
    btn.className = "lang-btn";
    btn.innerText = lang.toUpperCase();
    btn.setAttribute("data-lang", lang); // Сохраняем оригинальный ключ
    btn.onclick = () => switchLang(lang);
    container.appendChild(btn);
  });
}

function switchLang(lang) {
  const contentDiv = document.getElementById("promo-content");
  if (translations[lang]) {
    contentDiv.innerHTML = translations[lang];
    
    // Обновляем стили кнопок
    document.querySelectorAll(".lang-btn").forEach(btn => {
      if (btn.getAttribute("data-lang") === lang) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });
  }
}

function showDefault() {
  document.getElementById("promo-container").style.display = "none";
  document.getElementById("default-content").style.display = "block";
}
</script>
</body>
</html>