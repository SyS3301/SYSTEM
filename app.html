<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>App</title>
</head>
<body>
  <h1>Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ 3</h1>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”¹ Ð’ÑÑ‚Ð°Ð²ÑŒ ÑÑŽÐ´Ð° ÑÐ²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
const firebaseConfig = {
  apiKey: "AIzaSyD6GybNkPBa28UWm9rpPhkUe8Q4JYtqQm4",
  authDomain: "system-85dfe.firebaseapp.com",
  projectId: "system-85dfe",
  storageBucket: "system-85dfe.firebasestorage.app",
  messagingSenderId: "76734526218",
  appId: "1:76734526218:web:8a9eb4e0df4a58741980f3"
};

const SESSION_DURATION = 2 * 60 * 1000; // 2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function redirect() {
  window.location.href = "index.html";
}

let currentUser = null;

// Ð•Ð”Ð˜ÐÐ«Ð™ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    console.log("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½:", user.email);
    await checkSession(); // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐŸÐžÐ¡Ð›Ð• Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº user Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½
  } else {
    redirect();
  }
});

async function checkSession() {
  if (!currentUser) return;
  
  try {
    const userRef = doc(db, "users", currentUser.uid);
    const snap = await getDoc(userRef);
    
    if (snap.exists()) {
      const data = snap.data();
      const now = Date.now();
      
      // Ð‘Ð•Ð—ÐžÐŸÐÐ¡ÐÐžÐ• Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸:
      // Ð•ÑÐ»Ð¸ ÑÑ‚Ð¾ Firebase Timestamp, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ toMillis(), ÐµÑÐ»Ð¸ Ñ‡Ð¸ÑÐ»Ð¾ - Ð±ÐµÑ€ÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ
      let loginAtMs = 0;
      if (data.loginAt && typeof data.loginAt.toMillis === 'function') {
        loginAtMs = data.loginAt.toMillis();
      } else if (typeof data.loginAt === 'number') {
        loginAtMs = data.loginAt;
      }

      if (loginAtMs === 0) return; // Ð–Ð´ÐµÐ¼, Ð¿Ð¾ÐºÐ° Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ·ÑÑ‚ÑÑ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾

      const diff = now - loginAtMs;
      console.log("ÐŸÑ€Ð¾ÑˆÐ»Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ (ÑÐµÐº):", Math.floor(diff / 1000));

      if (diff > SESSION_DURATION) {
        console.log("Ð¡ÐµÑÑÐ¸Ñ Ð¸ÑÑ‚ÐµÐºÐ»Ð°, Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ð¼...");
        await signOut(auth);
        // Ð ÐµÐ´Ð¸Ñ€ÐµÐºÑ‚ ÑÑ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ‡ÐµÑ€ÐµÐ· onAuthStateChanged
      }
    }
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ ÑÐµÑÑÐ¸Ð¸:", error);
  }
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 ÑÐµÐºÑƒÐ½Ð´
setInterval(() => {
  if (currentUser) checkSession();
}, 5000);
</script>
</body>
</html>
