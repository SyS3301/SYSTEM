<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>App</title>
</head>
<body>
  <h1>Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ 4</h1>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ðŸ”¹ Ð’ÑÑ‚Ð°Ð²ÑŒ ÑÑŽÐ´Ð° ÑÐ²Ð¾Ð¹ ÐºÐ¾Ð½Ñ„Ð¸Ð³
const firebaseConfig = {
  apiKey: "AIzaSyD6GybNkPBa28UWm9rpPhkUe8Q4JYtqQm4",
  authDomain: "system-85dfe.firebaseapp.com",
  projectId: "system-85dfe",
  storageBucket: "system-85dfe.firebasestorage.app",
  messagingSenderId: "76734526218",
  appId: "1:76734526218:web:8a9eb4e0df4a58741980f3"
};

const SESSION_DURATION = 2 * 60 * 1000; // 2 Ð¼Ð¸Ð½ÑƒÑ‚Ñ‹
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function redirect() {
  window.location.href = "index.html";
}

let currentUser = null;

// Ð•Ð”Ð˜ÐÐ«Ð™ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸
onAuthStateChanged(auth, async (user) => {
  if (user) {
    currentUser = user;
    console.log("ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð¾Ð²Ð°Ð½:", user.email);
    await checkSession(); // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÐµÑÑÐ¸ÑŽ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐŸÐžÐ¡Ð›Ð• Ñ‚Ð¾Ð³Ð¾, ÐºÐ°Ðº user Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½
  } else {
    redirect();
  }
});

async function checkSession() {
  if (!currentUser) return;
  
  try {
    const userRef = doc(db, "users", currentUser.uid);
    // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ { serverTimestamps: 'estimate' }, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð½Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ null Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ
    const snap = await getDoc(userRef);
    
    if (snap.exists()) {
      // snap.data() ÑÐ°Ð¼ Ð¿Ð¾ ÑÐµÐ±Ðµ Ð½Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸, Ð±ÐµÑ€ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð°ÐºÐºÑƒÑ€Ð°Ñ‚Ð½Ð¾
      const data = snap.data();
      const now = Date.now();
      
      // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ñ Ñ Ð¾Ñ†ÐµÐ½ÐºÐ¾Ð¹ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
      const loginAtTimestamp = snap.get("loginAt", { serverTimestamps: "estimate" });
      
      let loginAtMs = 0;
      if (loginAtTimestamp && typeof loginAtTimestamp.toMillis === 'function') {
        loginAtMs = loginAtTimestamp.toMillis();
      } else if (typeof loginAtTimestamp === 'number') {
        loginAtMs = loginAtTimestamp;
      }

      // Ð•ÑÐ»Ð¸ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð²ÑÑ‘ ÐµÑ‰Ðµ Ð½ÐµÑ‚ (ÑÐ¾Ð²ÑÐµÐ¼ Ð¿ÑƒÑÑ‚Ð°Ñ Ð±Ð°Ð·Ð°), Ð½Ð¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð´ÐµÐ»Ð°ÐµÐ¼
      if (!loginAtMs) {
        console.log("Ð’Ñ€ÐµÐ¼Ñ Ð²Ñ…Ð¾Ð´Ð° ÐµÑ‰Ðµ Ð½Ðµ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¾");
        return; 
      }

      const diff = now - loginAtMs;
      const secondsPassed = Math.floor(diff / 1000);
      console.log("ÐŸÑ€Ð¾ÑˆÐ»Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ (ÑÐµÐº):", secondsPassed);

      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼: ÐµÑÐ»Ð¸ Ð²Ñ€ÐµÐ¼Ñ Ð² Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¼ (Ð¸Ð·-Ð·Ð° Ñ€Ð°Ð·Ð½Ð¸Ñ†Ñ‹ Ñ‡Ð°ÑÐ¾Ð² ÐŸÐš Ð¸ ÑÐµÑ€Ð²ÐµÑ€Ð°), diff Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚Ñ€Ð¸Ñ†Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¼
      // Ð•ÑÐ»Ð¸ diff > SESSION_DURATION â€” Ð²Ñ‹ÐºÐ¸Ð´Ñ‹Ð²Ð°ÐµÐ¼
      if (diff > SESSION_DURATION) {
        console.log("Ð¡ÐµÑÑÐ¸Ñ Ð¸ÑÑ‚ÐµÐºÐ»Ð°");
        await signOut(auth);
      }
    }
  } catch (error) {
    console.error("ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐµ ÑÐµÑÑÐ¸Ð¸:", error);
  }
}

// ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¶Ð´Ñ‹Ðµ 5 ÑÐµÐºÑƒÐ½Ð´
setInterval(() => {
  if (currentUser) checkSession();
}, 5000);
</script>
</body>
</html>
