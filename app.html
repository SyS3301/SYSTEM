<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>App</title>
  <style>
    body { font-family: sans-serif; background: #0f0f12; color: white; padding: 20px; }
    #promo-container {
      display: none;
      background: linear-gradient(45deg, #4f46e5, #9333ea);
      padding: 40px;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }
    #default-content { display: none; }
    .debug-info { color: #555; font-size: 10px; margin-top: 50px; }
  </style>
</head>
<body>

  <div id="promo-container">Загрузка спец-контента...</div>

  <div id="default-content">
    <h1>Стандартный интерфейс</h1>
    <p>Добро пожаловать в обычный режим приложения.</p>
  </div>

  <div class="debug-info" id="debug">Status: Инициализация...</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyD6GybNkPBa28UWm9rpPhkUe8Q4JYtqQm4",
  authDomain: "system-85dfe.firebaseapp.com",
  projectId: "system-85dfe",
  storageBucket: "system-85dfe.firebasestorage.app",
  messagingSenderId: "76734526218",
  appId: "1:76734526218:web:8a9eb4e0df4a58741980f3"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const promoDiv = document.getElementById("promo-container");
const mainDiv = document.getElementById("default-content");
const debugDiv = document.getElementById("debug");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    debugDiv.innerText = "Status: Нет авторизации, редирект...";
    window.location.href = "index.html";
    return;
  }
  
  debugDiv.innerText = "Status: Авторизован как " + user.email + ". Проверка базы...";

  try {
    const promoRef = doc(db, "promo", "NuetuWkhDrGfCX8a1UxL");
    const snap = await getDoc(promoRef);

    if (snap.exists()) {
      const data = snap.data();
      const now = Date.now();
      // Важно: проверяем, что expiresAt существует и является Timestamp
      const expiresAt = data.expiresAt?.toMillis ? data.expiresAt.toMillis() : 0;

      console.log("Данные получены:", data);
      debugDiv.innerText = `Status: Документ найден. Active: ${data.active}, Now: ${now}, Exp: ${expiresAt}`;

      if (data.active === true && now < expiresAt) {
        promoDiv.innerHTML = data.html || "<h1>Контент не задан в поле html</h1>";
        promoDiv.style.display = "block";
        mainDiv.style.display = "none";
      } else {
        debugDiv.innerText += " -> Условия не выполнены, показываю дефолт.";
        showDefaultApp();
      }
    } else {
      debugDiv.innerText = "Status: Документ 'promo/NuetuWkhDrGfCX8a1UxL' НЕ НАЙДЕН в Firestore";
      showDefaultApp();
    }
  } catch (err) {
    console.error(err);
    debugDiv.innerText = "Status: Ошибка Firestore: " + err.message;
    // Если выскочит Alert, значит нужно поправить Rules в консоли Firebase
    alert("Ошибка базы: " + err.message);
    showDefaultApp();
  }
});

function showDefaultApp() {
  promoDiv.style.display = "none";
  mainDiv.style.display = "block";
}
</script>
</body>
</html>