<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>App</title>
</head>
<body>
  <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// üîπ –í—Å—Ç–∞–≤—å —Å—é–¥–∞ —Å–≤–æ–π –∫–æ–Ω—Ñ–∏–≥
const firebaseConfig = {
  apiKey: "AIzaSyD6GybNkPBa28UWm9rpPhkUe8Q4JYtqQm4",
  authDomain: "system-85dfe.firebaseapp.com",
  projectId: "system-85dfe",
  storageBucket: "system-85dfe.firebasestorage.app",
  messagingSenderId: "76734526218",
  appId: "1:76734526218:web:8a9eb4e0df4a58741980f3"
};

const SESSION_DURATION = 1 * 60 * 1000; // 1 –º–∏–Ω—É—Ç–∞

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

function redirect() {
  window.location.href = "index.html";
}

let currentUser = null;

onAuthStateChanged(auth, (user) => {
  if (user) {
    currentUser = user;
    checkSession(); // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ä–∞–∑—É –ø—Ä–∏ –≤—Ö–æ–¥–µ
  } else {
    redirect();
  }
});

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Å—Å–∏–∏
async function checkSession() {
  if (!currentUser) return; // –ó–∞—â–∏—Ç–∞, –µ—Å–ª–∏ —é–∑–µ—Ä –µ—â–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω
  
  const userRef = doc(db, "users", currentUser.uid);
  const snap = await getDoc(userRef);

  if (!snap.exists()) {
    await setDoc(
      userRef,
      {
        email: user.email ?? "",
        role: "user",
        createdAt: Date.now(),
        loginAt: Date.now()
      },
      { merge: true }
    );
    return;
  }

  const { loginAt } = snap.data() || {};
  if (!loginAt) {
    await setDoc(userRef, { loginAt: Date.now() }, { merge: true });
    return;
  }

  if (Date.now() - loginAt > SESSION_DURATION) {
    await signOut(auth);
    alert("–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞");
    redirect();
  }
}

// üîπ –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
onAuthStateChanged(auth, checkSession);

// üîπ –ê–≤—Ç–æ-–ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
setInterval(checkSession, 5000);

</script>
</body>
</html>
